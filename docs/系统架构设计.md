# 中医体质辨识与医院预约系统 - 系统架构设计文档

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-XX  
> **最后更新**: 2025-01-XX

---

## 1. 总体概述

系统采用“前后端分离 + 分层架构 + 缓存/消息中间件”的模式构建，核心思想是：前端专注交互体验，后端负责业务编排，数据和中间件提供可靠支撑，配合配置中心与持续交付体系，保证可扩展、可维护、可观测。

关键层次：

- **客户端层**：基于 Vue3 的 Web SPA，同时兼容 H5/桌面浏览器，后续可复用逻辑产出小程序/APP。
- **接入层**：Nginx / CDN 承担静态资源分发、HTTPS 终端、反向代理、多节点负载均衡。
- **应用层**：Spring Boot 应用（hospital-appointment-system），提供 REST API、WebSocket、消息推送、定时任务。
- **数据与中间件层**：MySQL（核心业务数据）、Redis（缓存、分布式锁、热点统计）、RabbitMQ（可选的异步通知）、OSS（头像/富文本文件存储）。
- **配置与运维支撑**：Nacos 配置中心、Swagger 接口文档、统一日志/监控。

---

## 2. 技术选型

| 层次 | 技术栈 | 说明 |
|------|--------|------|
| 前端 | Vue 3 + Vite + Element Plus + Pinia + Axios + ECharts | 单页应用、响应式 UI、数据可视化 |
| 后端 | Spring Boot 2.7.18 + MyBatis-Plus + Spring Security + JWT + Swagger | REST API、ORM、认证授权、接口文档 |
| 数据 | MySQL 8.0、Redis 6.0 | 持久化 + 缓存 |
| 消息 | WebSocket + STOMP、RabbitMQ（可选） | 实时对话、系统通知 |
| 存储 | 阿里云 OSS | 静态资源、头像、富文本图片 |
| DevOps | Nacos、Maven、npm、Git | 配置中心与构建工具 |

---

## 3. 后端分层架构

```
┌──────────────────────────────────────────────┐
│                 接入层 (Controller)          │
│  - REST API (UserController, Appointment...) │
│  - WebSocket Endpoint                        │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│                    业务层                     │
│  - Service Interface & Impl                  │
│  - 领域逻辑：预约、体质、药膳、文章、消息等     │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│                   数据访问层                  │
│  - MyBatis-Plus Mapper & XML                 │
│  - DTO/Entity/VO 转换                         │
└──────────────────────────────────────────────┘
┌──────────────────────────────────────────────┐
│                 基础设施层                    │
│  - SecurityConfig / JwtUtil / GlobalException│
│  - RedisUtil / CacheConstants                │
│  - MQ Producer & Consumer                    │
│  - OSS Client / FileService                  │
└──────────────────────────────────────────────┘
```

### 3.1 模块划分

| 包/模块 | 说明 |
|---------|------|
| `controller` | 接收 HTTP/WebSocket 请求，做参数校验与用户上下文解析 |
| `service` | 核心业务逻辑、事务控制、缓存协同 |
| `mapper` | 数据库存取，封装复杂 SQL |
| `entity` | 数据库实体 |
| `dto` / `vo` | 请求/响应对象，隔离展示模型与数据库模型 |
| `common` | 统一返回、错误码、常量、异常处理 |
| `config` | 安全配置、Redis、MyBatis-Plus、WebSocket、跨域等 |
| `util` | JWT 工具、Redis 工具、OSS 工具等 |
| `messaging` | 对话消息发布/监听、通知推送 |

---

## 4. 核心业务架构

### 4.1 预约与排班

1. 管理员配置科室、医生、排班信息。
2. 患者选择科室 → 医生 → 日期/时段发起预约。
3. Service 层校验号源（Redis 分布式锁 + MySQL 事务）并写入 `appointment` 表。
4. 通知服务推送预约成功消息给患者/医生。
5. 医生端工作台展示待接诊列表，可切换状态、填写接诊记录。

### 4.2 体质辨识

1. 前端请求问卷 (`GET /api/constitution/questionnaire`)，加载 66 题。
2. 患者提交答案后，后端计算各体质得分、判定主次体质。
3. 结果写入 `user_constitution_test`，并缓存至 Redis（30 min）。
4. 同步生成养生建议：体质调养、药膳推荐、穴位组合。

### 4.3 内容体系（药膳/穴位/文章）

- 高频查询列表使用 Redis 缓存，命名空间示例：`hospital:common:recipe:list`。
- 热门搜索词使用 Redis Sorted Set 存储 `search:hot_keywords`。
- 富文本图片/封面统一存放在 OSS，通过后端生成带签名的访问 URL。

### 4.4 医患对话与通知

- 会话与消息落库：`conversation`、`conversation_message`、`user_notification`。
- WebSocket + STOMP 提供实时推送；多节点场景下使用 Redis Pub/Sub 广播。
- 离线消息走系统通知中心，前端患者/医生端可一键标记已读、按类型筛选。

---

## 5. 前端架构

```
hospital-frontend
├── src
│   ├── api/            # Axios 封装与模块化接口
│   ├── components/     # 通用组件（图表卡片、上传等）
│   ├── composables/    # 组合式函数 useAvatarUpload 等
│   ├── router/         # 路由与权限守卫，区分角色
│   ├── stores/         # Pinia 状态管理（user/admin/doctor）
│   ├── utils/          # searchHistory、auth 等工具
│   └── views/          # 业务页面（患者/医生/管理员）
├── public/
└── vite.config.js
```

- **权限体系**：路由 `meta.roles` + Pinia + 路由守卫实现；Token 失效跳转登录。
- **UI 规范**：Element Plus + BEM 命名，统一色系；表格/图表等组件抽象复用。
- **可视化**：ECharts 统一封装，支持健康趋势、医生工作量、预约热力图等。
- **状态缓存**：Pinia + localStorage/sessionStorage，减少重复请求。

---

## 6. 数据流 & 时序

### 6.1 预约时序

```
Patient -> Frontend -> AppointmentController
        -> AppointmentService -> ScheduleMapper/DoctorMapper -> MySQL
        -> NotificationService -> Redis/RabbitMQ -> WebSocket/消息中心
```

### 6.2 体质测试时序

```
Patient -> ConstitutionController -> ConstitutionService
        -> QuestionnaireMapper -> MySQL
        -> ResultBuilder -> Redis Cache
        -> Response -> Frontend (展示报告 + 推荐)
```

### 6.3 实时对话时序

```
Patient/Doctor -> WebSocket -> ConversationService
               -> ConversationMapper -> MySQL
               -> Redis Pub/Sub -> 对端客户端
               -> NotificationService (离线) -> user_notification
```

---

## 7. 缓存 & 消息策略

### 7.1 缓存键构建规范

系统统一使用 `CacheKeyBuilder` 工具类构建缓存键，避免硬编码和重复拼接：

```java
// 示例：构建用户列表缓存键
String cacheKey = CacheKeyBuilder.of(CacheConstants.USER_LIST_CACHE_PREFIX)
    .appendPage(page, pageSize)
    .appendParamsHash(params)
    .build();
```

**缓存键命名规范**：
- 格式：`{前缀}:{模块}:{类型}:{标识}`
- 示例：`hospital:admin:user:list:p1:s10:h:a1b2c3d4`
- 分页参数使用 `:p{page}:s{size}` 格式
- 复杂参数使用哈希值 `:h:{hash}` 压缩

### 7.2 缓存TTL策略

统一使用 `CacheTtlPolicy` 枚举管理过期时间：

| 策略 | 过期时间 | 适用场景 |
|------|----------|----------|
| `CONVERSATION_MESSAGE_LIST` | 1分钟 | 会话消息列表 |
| `CONVERSATION_LIST` | 2分钟 | 会话列表 |
| `CONVERSATION_DETAIL` | 5分钟 | 会话详情 |
| `DOCTOR_DETAIL` | 30分钟 | 医生信息 |
| `AI_RECOMMENDATION` | 30分钟 | AI推荐结果 |
| `CONSTITUTION_TYPE` | 24小时 | 体质类型字典 |

### 7.3 缓存场景与降级

| 场景 | 缓存 Key 示例 | 过期时间 | 降级策略 |
|------|---------------|----------|----------|
| 文章/药膳列表 | `hospital:common:article:list` | 15-30 分钟 | 直接查询 DB，叠加限流 |
| 体质测试结果 | `hospital:constitution:result:{userId}` | 30 分钟 | 重新计算 |
| 热门搜索词 | `search:hot_keywords` (ZSet) | 永久 | 返回预置词库 |
| 会话头像签名 | `hospital:conversation:avatar:{id}` | 5 分钟 | 使用非签名 URL |

**消息通知**：

- RabbitMQ/Redis Stream：预约状态、医生回复、接诊完成等系统消息。
- WebSocket：实时消息推送；离线则落地 user_notification，前端轮询/拉取。

---

## 8. 配置与部署架构

### 8.1 配置中心（Nacos）

- `hospital-appointment-system-dev.yaml`：数据库、Redis、JWT、OSS、MQ、日志、跨域等。
- `hospital-frontend-dev.yaml`：API Base URL、OSS 直传、主题配置等。
- 区分命名空间（dev/staging/prod），变更支持灰度与回滚。

### 8.2 部署拓扑

```
[用户浏览器]
      |
   HTTPS
      |
    [Nginx/CDN]
    /         \
[Front SPA]  [Spring Boot 集群]
                   |
        ┌──────────┴───────────┐
      [MySQL]   [Redis]   [RabbitMQ]
                   |
                 [OSS]
```

- 前端构建成静态资源，部署在 Nginx/OSS/云存储。
- 后端可多实例部署，依赖 JWT + Redis 实现无状态扩容。
- 数据库可按需做主从/读写分离；Redis 可哨兵或集群部署。

### 8.3 日志与监控

- Logback + JSON 输出，区分 INFO/ERROR，附带 traceId。
- OperationLog 注解记录关键操作，便于审计追踪。
- 建议集成 Prometheus + Grafana 或阿里云 ARMS 采集 JVM/接口指标。

---

## 9. 错误码规范

### 9.1 错误码分类

系统采用分层错误码体系，便于问题定位和分类处理：

| 范围 | 类型 | 说明 |
|------|------|------|
| 200-299 | 通用状态码 | 成功、系统错误等 |
| 400-499 | 客户端错误 | 参数错误、未授权、资源不存在等 |
| 500-599 | 服务器错误 | 内部错误、服务不可用等 |
| 1000-1099 | 用户相关 | 用户不存在、已存在、账号禁用等 |
| 1100-1199 | Token相关 | Token无效、过期、缺失等 |
| 1200-1299 | 医生相关 | 医生不存在、不可用等 |
| 1300-1399 | 科室相关 | 科室不存在、编码冲突等 |
| 1400-1499 | 排班相关 | 排班不存在、时间冲突、号源已满 |
| 1500-1599 | 预约相关 | 预约不存在、号源不足、状态错误 |
| 1600-1699 | 支付相关 | 支付失败、超时、金额错误 |
| 1700-1799 | 患者相关 | 患者关联数据、未完成预约 |
| 1800-1899 | 体质测试相关 | 测试记录不存在、未完成、类型不存在 |
| 1900-1999 | 药膳相关 | 药膳不存在、已收藏、未收藏 |
| 2000-2099 | 数据库相关 | 查询、插入、更新、删除失败 |
| 2100-2199 | 缓存相关 | 缓存操作失败、键不存在 |
| 2200-2299 | 健康打卡相关 | 打卡记录不存在、今日已打卡 |
| 2300-2399 | 统计相关 | 统计数据查询失败 |
| 2400-2499 | 文件上传相关 | 上传失败、类型不支持、大小超限 |
| 2500-2599 | AI推荐相关 | 推荐失败、服务不可用 |

### 9.2 异常处理

`GlobalExceptionHandler` 统一处理异常，支持：
- **业务异常**：`BusinessException`，返回对应错误码和消息
- **参数校验异常**：`MethodArgumentNotValidException`，返回字段级错误信息
- **系统异常**：记录 traceId 便于追踪，返回友好错误提示

**日志格式**：
```
业务异常 [traceId={traceId}, method={method}, uri={uri}, code={code}, message={message}]
```

## 10. 安全设计

- **认证**：JWT + Spring Security，Token 存 Redis（黑名单机制），支持退出/失效。
- **授权**：角色粒度（患者/医生/管理员） + 注解/表达式控制接口访问。
- **数据安全**：密码 Bcrypt 加密、头像 URL 清洗、敏感字段脱敏。
- **输入校验**：Hibernate Validator + 全局异常，避免脏数据。
- **防护措施**：CSRF 防护、XSS 过滤、SQL 预编译、接口限流/验证码。

---

## 11. DTO映射规范

系统使用 **MapStruct** 进行对象映射，替代手写 `BeanUtils.copyProperties`：

### 11.1 映射器定义

```java
@Mapper(componentModel = "spring")
public interface DtoMapper {
    // User实体转UserInfoResponse
    @Mapping(target = "doctorId", ignore = true)
    UserInfoResponse toUserInfoResponse(User user);
    
    // 列表映射
    List<UserInfoResponse> toUserInfoResponseList(List<User> users);
    
    // 复杂映射（预约转统计DTO）
    @Mapping(source = "appointmentDate", target = "date", dateFormat = "yyyy-MM-dd")
    StatisticsDTO.RecentAppointment toRecentAppointment(Appointment appointment);
}
```

### 11.2 使用规范

- 所有 DTO 与 Entity 之间的转换统一使用 `DtoMapper`
- 忽略字段使用 `@Mapping(target = "field", ignore = true)`
- 日期格式转换使用 `dateFormat` 参数
- 复杂字段映射使用 `@Mapping(source = "src", target = "dst")`

## 12. 可扩展性与演进

| 方向 | 说明 |
|------|------|
| 微服务拆分 | 可按预约、内容、消息、统计等拆分服务，使用注册中心与 RPC。 |
| 多端扩展 | 基于组合式 API、服务抽象，快速延伸到小程序/APP。 |
| AI 能力 | 结合 AI 推荐缓存常量，后续可引入大模型做问答、推荐解释。 |
| 数据中台 | 统计模块开放统一数据 API，供 BI 与报表系统消费。 |

---

## 13. 风险与改进建议

| 风险 | 影响 | 建议 |
|------|------|------|
| 并发预约超卖 | 数据不一致 | Redis 分布式锁 + Lua 原子扣减号源 |
| WebSocket 扩容 | 消息丢失 | Redis Pub/Sub 或 MQ 做广播，保障多实例同步 |
| 缓存穿透/击穿 | DB 压力 | 加布隆过滤器、热点预热、限流熔断 |
| 配置混乱 | 发布风险 | 所有敏感配置统一进 Nacos，启用加密与灰度策略 |
| 头像签名过期 | 图片无法显示 | 前端统一通过后端获取签名 URL，并在前端缓存/刷新 |

---

**文档结束**

