# 中医体质辨识与医院预约系统 - 数据库设计文档

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-XX  
> **最后更新**: 2025-01-XX

---

## 1. 设计原则

1. **三范式优先，业务驱动适度反范式**：核心实体保持第三范式，热点统计（如浏览数、点赞数）在表内冗余字段。
2. **命名规范**：统一使用 `snake_case`，表名前缀遵循业务域（如 `user_`, `appointment_`, `constitution_`）。
3. **主键策略**：大多数表使用雪花 ID（MyBatis-Plus `ASSIGN_ID`），少量配置表使用自增 ID。
4. **软删除 vs 硬删除**：业务主表使用 `is_deleted` + 逻辑删除，日志、统计类允许硬删除或定期归档。
5. **多租户/多角色兼容**：用户信息拆分为 `user`（基表）+ `patient/doctor` 扩展表，方便后续角色扩展。

---

## 2. 数据库概览

| 模块 | 表名 | 描述 |
|------|------|------|
| 用户与权限 | `user`, `patient`, `doctor`, `role`, `user_role`, `operation_log` | 用户信息、角色、操作日志 |
| 预约排班 | `department`, `doctor_schedule`, `appointment`, `consultation_record`, `payment_record` | 科室、排班、预约、接诊、支付 |
| 体质辨识 | `constitution_type`, `constitution_questionnaire`, `questionnaire_option`, `user_constitution_test` | 体质类型、问卷、测试记录 |
| 健康管理 | `user_health_profile`, `health_checkin`, `health_plan_record` | 健康档案、打卡、养生方案 |
| 药膳推荐 | `herbal_recipe`, `ingredient`, `recipe_ingredient`, `user_recipe_favorite` | 食谱、食材、收藏 |
| 穴位指导 | `acupoint`, `acupoint_combination`, `acupoint_combination_detail` | 穴位及组合方案 |
| 养生社区 | `health_article`, `article_comment`, `user_like`, `user_article_favorite` | 文章、评论、点赞、收藏 |
| 搜索与推荐 | `search_keyword_stat`, `ai_recommendation_record` | 搜索热词、AI 推荐缓存 |
| 对话与通知 | `conversation`, `conversation_participant`, `conversation_message`, `user_notification` | 会话、消息、通知 |
| 系统配置 | `system_config`, `dictionary`, `dictionary_item` | 配置与数据字典 |

---

## 3. 表结构说明

### 3.1 用户与权限

#### `user`

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | bigint | 主键，雪花 ID |
| `username` | varchar(50) | 登录账号，唯一 |
| `password` | varchar(100) | Bcrypt 加密密码 |
| `real_name` | varchar(50) | 真实姓名 |
| `phone` | varchar(20) | 手机号 |
| `email` | varchar(100) | 邮箱 |
| `avatar` | varchar(255) | 头像 URL（存储无签名） |
| `role_type` | tinyint | 1-患者 / 2-医生 / 3-管理员 |
| `status` | tinyint | 1-启用 / 0-禁用 |
| `created_at/updated_at` | datetime | 创建/更新时间 |

**索引**：`uk_username`, `idx_phone`, `idx_role_status`

#### `patient`

- 与 `user` 1:1，对应患者拓展信息（性别、出生日期、体质倾向、既往病史等）
- 外键 `user_id`（唯一索引）

#### `doctor`

- 记录医生身份信息、职称、科室、简介、擅长领域、排班策略
- 外键 `user_id`

#### `operation_log`

- 记录模块、操作人、类型、入参/出参、耗时
- 方便审计与问题定位

### 3.2 科室与排班

#### `department`

| 字段 | 说明 |
|------|------|
| `id`, `dept_name`, `dept_code`, `description`, `display_order`, `status` |

#### `doctor_schedule`

| 字段 | 说明 |
|------|------|
| `id`, `doctor_id`, `schedule_date`, `time_slot`(MORNING/AFTERNOON/EVENING), `capacity`, `remain_quota`, `is_open` |

**约束**：`uniq_doctor_date_slot`（避免重复排班）

### 3.3 预约与接诊

#### `appointment`

| 字段 | 类型/说明 |
|------|-----------|
| `id`, `patient_id`, `doctor_id`, `department_id`, `schedule_id` |
| `appointment_date`, `time_slot`, `queue_number` |
| `status` (CREATED/CONFIRMED/CANCELLED/COMPLETED/NO_SHOW) |
| `cancel_reason`, `cancel_by`, `remark` |
| `created_at`, `updated_at`, `is_deleted` |

索引：`idx_patient_date`, `idx_doctor_date`

#### `consultation_record`

- 关联预约，记录诊断、处方、医嘱等
- `attachment_urls` JSON 存储检查单、处方图片

### 3.4 体质辨识

#### `constitution_type`

- 9 种体质，存储编码、名称、特征、养生建议、饮食建议、情志调养等

#### `constitution_questionnaire`

| 字段 | 说明 |
|------|------|
| `id`, `question_no`, `question_text`, `dimension`(QIXU/YANGXU 等), `score_mapping` |

#### `questionnaire_option`

- 存储题目选项、分值、描述

#### `user_constitution_test`

| 字段 | 说明 |
|------|------|
| `id`, `user_id`, `score_map`(JSON), `primary_type`, `secondary_type`, `suggestion`, `test_time` |

索引：`idx_user_time`

### 3.5 健康管理

- `user_health_profile`: 身高、体重、BMI、过敏史、慢性病、生活习惯等
- `health_checkin`: 每日打卡（weight, sleep_hours, exercise_minutes, mood_level, remark）
- `health_plan_record`: 养生方案执行情况、医生建议、完成状态

### 3.6 药膳推荐

| 表 | 说明 |
|----|------|
| `herbal_recipe` | 基础信息（名称、封面、功效、体质适配、季节推荐、制作步骤） |
| `ingredient` | 食材库（名称、性味归经、用量单位） |
| `recipe_ingredient` | 食谱-食材多对多表 |
| `user_recipe_favorite` | 患者收藏记录，含备注、创建时间 |

### 3.7 穴位指导

- `acupoint`: 穴位名称、经络、位置、功效、操作方法、禁忌
- `acupoint_combination`: 组合方案（适应症、调理策略）
- `acupoint_combination_detail`: 方案与穴位关联

### 3.8 养生知识社区

| 表 | 关键字段 |
|----|----------|
| `health_article` | `title`, `summary`, `content`, `cover_image`, `author_id`, `category`, `tags`, `view_count`, `like_count`, `favorite_count`, `comment_count`, `is_featured`, `publish_time` |
| `article_comment` | 支持二级评论（`parent_id`），记录点赞数 |
| `user_like` | 用户点赞（文章/评论），字段 `biz_type` + `biz_id` |
| `user_article_favorite` | 文章收藏 |

### 3.9 搜索与推荐

- `search_keyword_stat`: `keyword`, `score`, `last_search_time`
- `ai_recommendation_record`: 存储 AI 推荐的输入、输出、命中规则、缓存 key

### 3.10 会话与通知

| 表 | 说明 |
|----|------|
| `conversation` | 会话主体（参与方、类型、最新消息、未读数量） |
| `conversation_participant` | 会话成员及删除状态 |
| `conversation_message` | 消息内容（文本/图片/文件）、发送者、阅读状态 |
| `user_notification` | 系统通知、预约提醒、医生回复等 |

### 3.11 系统配置

- `system_config`: Key-Value 配置（缓存策略、短信开关等）
- `dictionary` / `dictionary_item`: 字典及子项（体质枚举、时间段、消息类型）

---

## 4. ER 关系描述

1. **用户与角色**：`user` 与 `role` 多对多，通过 `user_role` 关联；患者/医生通过拓展表附加信息。
2. **科室-医生-排班-预约**：`department` 1:N `doctor`，`doctor` 1:N `doctor_schedule`，`appointment` 关联患者和排班。
3. **体质测试**：`constitution_questionnaire` 与 `questionnaire_option` 为 1:N；`user_constitution_test` 与 `user` 为 N:1。
4. **内容收藏/点赞**：通过 `user_like`、`user_article_favorite`、`user_recipe_favorite` 记录用户行为，利于后续推荐。
5. **会话消息**：`conversation` 与 `conversation_message` 1:N，通过 `conversation_participant` 管理多端逻辑删除与未读数。

---

## 5. 索引与性能优化

| 场景 | 索引策略 | 说明 |
|------|----------|------|
| 登录 / 用户查询 | `user.username`, `user.phone` 唯一索引 | 提高认证效率 |
| 预约查询 | `appointment.patient_id + appointment_date`, `appointment.doctor_id + appointment_date` | 高频筛选字段 |
| 排班查找 | `doctor_schedule.doctor_id + schedule_date + time_slot` | 保障唯一性并提升查询速度 |
| 体质历史 | `user_constitution_test.user_id + test_time` | 支持按时间排序 |
| 内容检索 | `health_article.category`, `health_article.tags`（前缀索引） | 帮助文章筛选 |
| 搜索热词 | `search_keyword_stat.score` ZSet | Redis 维护排序，MySQL 定期落库 |

热点场景（文章浏览、预约统计）使用 Redis 缓存，并通过定时任务/异步刷写保持一致性。

---

## 6. 数据一致性与事务

| 场景 | 事务方案 |
|------|----------|
| 创建预约 | MySQL 事务 + Redis 分布式锁，确保号源扣减与记录写入一致 |
| 取消预约 | 更新预约状态 + 回滚号源，需要幂等处理 |
| 体质测试提交 | 计算写入 + 缓存刷新放在同一事务后触发 |
| 会话消息 | 消息落库与通知放在两阶段：先写库，再异步推送 |

---

## 7. 分库分表与扩展

短期使用单库，预留以下扩展策略：

- **分库**：按业务域（预约、内容、消息）拆分数据库。
- **分表**：对高并发表（`conversation_message`, `user_notification`, `health_article`）按时间/用户分表。
- **归档**：历史预约、通知定期归档到冷数据表（`*_history`）。

---

## 8. 数据安全与备份

1. **权限控制**：数据库账号按模块最小权限配置。
2. **备份策略**：每日全备 + 每小时增量备份，保留 7-30 天；关键表支持 binlog 恢复。
3. **加密字段**：密码、Token、敏感备注不落库或加密/脱敏存储。
4. **审计**：操作日志表记录核心增删改操作，便于追责。

---

**文档结束**

