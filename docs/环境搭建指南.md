# 中医体质辨识与医院预约系统 - 环境搭建指南

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-XX  
> **最后更新**: 2025-01-XX  
> **适用范围**: 开发/测试环境初始化

---

## 1. 必备软件

| 组件 | 版本建议 | 说明 |
|------|----------|------|
| 操作系统 | Windows 11 / macOS / Linux | 任意平台均可 |
| JDK | 17+ | 推荐 Azul/OpenJDK 17 LTS |
| Maven | 3.6+ | `mvn -v` 验证 |
| Node.js | 18 LTS | 搭配 npm 9+ 或 pnpm |
| MySQL | 8.0+ | 启用 UTF8MB4、大小写不敏感 |
| Redis | 6.0+ | 单机或哨兵均可 |
| Nacos | 2.2+ | 配置中心（可选单机） |
| RabbitMQ | 3.8+ | 异步通知（可选，若无需可关闭） |
| Git | 2.40+ | 代码版本管理 |

---

## 2. 数据库初始化

1. 创建数据库：
   ```sql
   CREATE DATABASE hospital_appointment_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
2. 导入建表脚本：
   ```bash
   mysql -u root -p hospital_appointment_system < sql/tcm_health_system.sql
   mysql -u root -p hospital_appointment_system < sql/constitution_questionnaire_data.sql
   ```
3. 如有增量脚本位于 `sql/migrations/`，按时间顺序执行。
4. 建议创建独立账号：
   ```sql
   CREATE USER 'hospital'@'%' IDENTIFIED BY 'StrongPassword!';
   GRANT ALL ON hospital_appointment_system.* TO 'hospital'@'%';
   FLUSH PRIVILEGES;
   ```

---

## 3. Redis & RabbitMQ

### Redis
- `redis-server` 启动后修改 `redis.conf`，确保 `requirepass` 与 `protected-mode no`（按需）。
- 常见配置放置在 Nacos `redis:` 节点，包含 host、port、password、database。

### RabbitMQ（可选）
- 安装后启用管理界面：`rabbitmq-plugins enable rabbitmq_management`
- 创建虚拟主机 `hospital-vhost` 与账号 `hospital/hospital123`
- 若暂不需要消息通知，可在配置中关闭相关功能，系统会 graceful degrade。

---

## 4. Nacos 配置中心

1. 解压并启动：
   ```bash
   # 单机模式
   startup.cmd -m standalone
   ```
2. 访问 `http://localhost:8848/nacos`（默认账号 `nacos/nacos`）。
3. 创建命名空间 `dev`，导入 `docs/nacos/hospital-appointment-system-dev.yaml` 与 `hospital-frontend-dev.yaml`。
4. JVM 启动参数需要指定：
   ```
   -Dnacos.config.server-addr=127.0.0.1:8848
   -Dnacos.config.namespace=dev
   ```
5. 敏感配置（数据库、Redis、OSS）统一放在 Nacos，`application.yml` 仅保留最小兜底。

---

## 5. 后端项目启动

1. 安装依赖：
   ```bash
   cd hospital-appointment-system
   mvn clean install -DskipTests
   ```
2. 配置环境变量（可在 IDE Run Configuration）：
   ```
   NACOS_SERVER_ADDR=127.0.0.1:8848
   NACOS_NAMESPACE=dev
   SPRING_PROFILES_ACTIVE=dev
   ```
3. 运行：
   ```bash
   mvn spring-boot:run
   # or
   java -jar target/hospital-appointment-system-1.0.0.jar
   ```
4. 验证：
   - `http://localhost:8080/api/ping`（若有健康检查）
   - MySQL/Redis 日志无报错
   - 控制台打印 Nacos 配置加载成功

---

## 6. 前端项目启动

1. 安装依赖：
   ```bash
   cd hospital-frontend
   npm install    # 或 pnpm install
   ```
2. 配置 `.env.development`（若使用 Nacos 配置可从接口拉取）：
   ```
   VITE_BASE_API=http://localhost:8080
   VITE_OSS_REGION=cn-hangzhou
   ```
3. 启动：
   ```bash
   npm run dev
   ```
4. 访问 `http://localhost:3000`，使用默认账号登录（如 admin/admin123）。

---

## 7. OSS（阿里云对象存储）

1. 创建 Bucket（推荐 `oss-cn-hangzhou`），设置公私读。
2. 在后台配置 AccessKeyId/Secret、Bucket、Endpoint。
3. 使用 `PUT /api/oss/policy` 获取临时凭证，前端通过 Element Upload 直传。

如无 OSS，可临时改为本地磁盘存储，待生产环境迁移。

---

## 8. 常见问题

| 问题 | 处理方式 |
|------|----------|
| 端口占用 | 调整 `server.port` 或前端 `VITE_PORT` |
| 跨域 | `CorsConfig` 已放开常见来源，若部署到同域可关闭 |
| Token 失效 | Redis 中 Token 过期/黑名单，重新登录即可 |
| MySQL 连接失败 | 检查防火墙、账户权限、`allowPublicKeyRetrieval` |
| Nacos 读取失败 | 确认命名空间、DataId、Group 与启动参数一致 |

---

## 9. 目录结构速览

```
hospital/
├─ hospital-appointment-system/    # Spring Boot 后端
├─ hospital-frontend/              # Vue3 前端
├─ docs/                           # 文档
├─ sql/                            # 数据库脚本
└─ README_TCM_SYSTEM.md
```

---

**文档结束**

