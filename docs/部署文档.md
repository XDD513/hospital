# 中医体质辨识与医院预约系统 - 部署文档

> **文档版本**: v1.0.0  
> **创建日期**: 2025-01-XX  
> **最后更新**: 2025-01-XX

---

## 1. 部署目标

- **模式**：前后端分离，后端运行在 Linux 服务器（推荐 CentOS/Ubuntu），前端静态资源托管在 Nginx/OSS/CDN。
- **依赖服务**：MySQL、Redis、Nacos、RabbitMQ（可选）、OSS。
- **环境**：`dev`、`staging`、`prod` 三套命名空间，配置由 Nacos 管理。

---

## 2. 后端部署

### 2.1 构建

```bash
cd hospital-appointment-system
mvn clean package -DskipTests
```

生成 `target/hospital-appointment-system-1.0.0.jar`。

### 2.2 配置

1. 在 Nacos `prod` 命名空间创建 DataId `hospital-appointment-system-prod.yaml`，内容包含：
   - 数据源配置
   - Redis、RabbitMQ
   - OSS、短信、JWT、缓存策略
2. 设置 JVM 环境变量：
   ```
   -Dnacos.config.server-addr=10.0.0.10:8848
   -Dnacos.config.namespace=prod
   -Dspring.profiles.active=prod
   ```
3. 可选：通过 `application-prod.yml` 配置兜底项，但以 Nacos 为准。

### 2.3 启动脚本

```bash
#!/bin/bash
APP_NAME=hospital-appointment-system
JAR=target/$APP_NAME-1.0.0.jar
LOG_DIR=/var/log/$APP_NAME
JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"
JAVA_OPTS="$JAVA_OPTS -Dnacos.config.server-addr=10.0.0.10:8848 -Dnacos.config.namespace=prod"

mkdir -p $LOG_DIR
nohup java $JAVA_OPTS -jar $JAR > $LOG_DIR/app.log 2>&1 &
echo $! > $APP_NAME.pid
```

停止脚本：
```bash
kill $(cat hospital-appointment-system.pid)
```

### 2.4 运行检查

| 项目 | 验证方式 |
|------|----------|
| 端口监听 | `netstat -tunlp | grep 8080` |
| 日志健康 | `tail -f /var/log/.../app.log` |
| 数据库连接 | 日志无 `Communications link failure` |
| Redis 连接 | 日志无 `RedisConnectionFailureException` |
| Nacos 配置 | 日志有 `Refresh final config` |

---

## 3. 前端部署

### 3.1 构建

```bash
cd hospital-frontend
npm install
npm run build
```

生成 `dist/` 静态文件。

### 3.2 Nginx 配置示例

```
server {
    listen 80;
    server_name tcm.example.com;

    root /var/www/tcm/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

如将静态资源托管在 OSS/CDN，请确保启用 HTTPS 并配置跨域（允许前端域访问后端 API）。

---

## 4. 数据库 & Redis

| 操作 | 说明 |
|------|------|
| MySQL | 创建生产库，执行建表脚本；定期备份（全备+增量） |
| Redis | 部署主从或哨兵；设置密码；监控内存占用 |
| 定时任务 | 可使用 crontab 调度备份、日志清理等 |

---

## 5. 日志与监控

1. **日志**：Logback 输出到 `/var/log/hospital-appointment-system/app.log`；按天滚动。
2. **监控**：建议使用 Prometheus + Grafana 或云监控采集指标（JVM、HTTP、数据库、Redis）。
3. **报警**：关键错误/异常触达钉钉或企业微信。

---

## 6. 灰度与回滚

1. 采用 **蓝绿部署** 或 **滚动升级**：
   - 启动新版本实例
   - 健康检查通过后切换负载（Nginx upstream / SLB）
   - 观察无异常后下线旧版本
2. 配置版本管理：
   - 记录每次发布的 Git commit hash
   - jar 与静态包保留至少两版
3. 回滚步骤：
   - 快速切回旧版本 jar/static
   - 恢复对应 Nacos 配置或环境变量
   - 如涉及数据库变更，提前准备回滚脚本

---

## 7. 常见问题

| 问题 | 排查建议 |
|------|----------|
| 502 Bad Gateway | 检查后端进程是否存活、Nginx upstream 配置 |
| 静态资源 404 | 确保 `try_files` 指向 `/index.html` |
| CORS 报错 | 后端 `CorsConfig` 生效/或 Nginx 添加 `add_header Access-Control-Allow-Origin *` |
| Token 失效频繁 | 检查 Redis 过期时间或多实例间的 Token 同步 |
| 消息推送失败 | 确认 RabbitMQ/Redis PubSub 配置、WebSocket 心跳 |

---

## 8. 发布流程（建议）

1. 提交代码并通过 CI（单元测试 + 构建）。
2. 生成版本号（如 `v1.0.0-20251124`）。
3. 上传后端 jar 至制品库或服务器。
4. 上传前端静态资源至对象存储或 Nginx。
5. 执行数据库迁移脚本（若有），确认成功。
6. 启动新版本，执行健康检查。
7. 切流，观察日志及监控至少 15 分钟。
8. 完成发布，更新文档与版本记录。

---

**文档结束**

